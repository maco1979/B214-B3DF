## 前端性能深度优化计划

### 一、最高优先级：请求层极致优化

#### 1. 精准按需请求实现
- **修改文件**：`src/services/api.ts`
- **实现内容**：
  - 添加注意力权重相关API端点：`getAttentionWeights`、`getDomainFeatures`、`getTransferMatrix`
  - 支持传入精准参数：`sample_id`、`layer`、`head`、`domain_type`、`seq_len`
  - 后端只返回指定维度的数据，避免全量返回

#### 2. 全维度缓存策略
- **新增文件**：`src/utils/cache.ts`
- **实现内容**：
  - 实现三级缓存：`localStorage`（静态数据）、`sessionStorage`（半静态数据）、内存缓存（动态数据）
  - 支持缓存版本控制，自动失效机制
  - 实现缓存键生成、数据序列化/反序列化
  - 集成到API客户端中，自动缓存请求结果

#### 3. 合并请求 + 防抖节流
- **修改文件**：`src/services/api.ts`、`src/hooks/useDebounce.ts`、`src/hooks/useThrottle.ts`
- **实现内容**：
  - 实现200-300ms防抖，用于切换层/头/样本/域等交互
  - 实现500ms节流，用于滚动热力图、拖动滑块等实时交互
  - 实现请求合并，将多个相关请求合并为一个

### 二、第二优先级：大体积数据传输专项优化

#### 1. 结构化数据轻量化
- **修改文件**：`src/services/api.ts`
- **实现内容**：
  - 实现扁平化数据转换，将嵌套JSON转换为一维数组
  - 实现数据解析工具，前端自行还原矩阵结构
  - 支持只返回有效数据，剔除冗余字段

#### 2. 启用无损压缩传输
- **修改文件**：`src/services/api.ts`
- **实现内容**：
  - 添加压缩请求头，支持gzip/brotli压缩
  - 实现压缩数据自动解压逻辑

#### 3. 数据裁剪
- **修改文件**：`src/services/api.ts`
- **实现内容**：
  - 支持传入精度参数，后端只返回指定精度的数据
  - 实现前端驱动的数据裁剪逻辑

### 三、第三优先级：前端可视化渲染层极致优化

#### 1. 画布复用 + 避免重复渲染
- **新增文件**：`src/components/AttentionHeatmap.tsx`
- **实现内容**：
  - 复用ECharts实例，只更新数据
  - 实现组件级别的状态管理，避免不必要的重渲染
  - 优化数据更新逻辑，减少DOM操作

#### 2. 虚拟渲染/区域裁剪
- **修改文件**：`src/components/AttentionHeatmap.tsx`
- **实现内容**：
  - 启用ECharts的`large:true`配置
  - 实现热力图虚拟渲染，只渲染可见区域
  - 支持超大seq_len（512+）的流畅渲染

#### 3. Web Worker承载计算逻辑
- **新增文件**：`src/workers/attention-calculator.worker.ts`
- **实现内容**：
  - 将注意力权重归一化、梯度计算、相似度计算等逻辑移至Web Worker
  - 实现主线程与Worker的通信机制
  - 支持并行计算，提高处理速度

### 四、第四优先级：前后端协同异步解耦

#### 1. 长耗时请求异步化处理
- **修改文件**：`src/services/api.ts`、`src/hooks/useAsyncTask.ts`
- **实现内容**：
  - 实现「异步任务提交 + 轮询查询结果」的完整流程
  - 支持任务提交、状态查询、结果获取
  - 实现任务进度展示组件
  - 支持取消任务功能

#### 2. 前端感知后端负载
- **修改文件**：`src/services/api.ts`、`src/utils/loadBalancer.ts`
- **实现内容**：
  - 添加后端负载状态查询接口
  - 实现前端负载感知逻辑
  - 动态调整请求频率和优先级
  - 实现请求队列管理，根据负载动态调度

### 五、第五优先级：前端侧计算下沉

#### 1. 计算任务下沉实现
- **修改文件**：`src/workers/attention-calculator.worker.ts`
- **实现内容**：
  - 注意力权重的归一化/标准化
  - 领域相似度的余弦相似度计算
  - 注意力归因分析的梯度加权求和
  - t-SNE/PCA特征降维的前端可视化层降维
  - 注意力权重的统计分析
  - 跨域迁移矩阵的权重分布可视化预处理

### 六、第六优先级：前端接口容错 + 资源保护

#### 1. 请求参数前置校验
- **修改文件**：`src/services/api.ts`、`src/utils/validator.ts`
- **实现内容**：
  - 实现请求参数的前端校验逻辑
  - 无效请求直接在前端拦截
  - 支持动态参数校验规则

#### 2. 指数退避重试
- **修改文件**：`src/services/api.ts`
- **实现内容**：
  - 实现指数退避重试机制
  - 支持可配置的重试次数和间隔
  - 避免高频重试打满后端接口

#### 3. 请求熔断 + 降级
- **修改文件**：`src/services/api.ts`、`src/utils/circuitBreaker.ts`
- **实现内容**：
  - 实现请求熔断机制，连续失败N次后触发熔断
  - 实现降级策略，展示缓存数据或默认内容
  - 支持自动恢复机制

### 预期效果

1. **请求层优化**：
   - 请求量减少70%+
   - 重复请求率降至0
   - 后端算力释放50%+

2. **数据传输优化**：
   - 数据传输体积减少60%~90%
   - 解析速度提升5~20倍
   - 网络传输时间从秒级降至毫秒级

3. **可视化渲染优化**：
   - 热力图渲染帧率从10fps提升至60fps
   - 页面交互无卡顿
   - 支持超大seq_len的流畅渲染

4. **前后端协同优化**：
   - 长耗时请求不阻塞后端，支持并行处理
   - 前端页面流畅，展示任务进度
   - 后端算力利用率提高30%+

5. **计算下沉优化**：
   - 后端算力释放20%~40%
   - 前端响应速度极快，无网络延迟
   - 系统吞吐量提升30%+

6. **接口容错优化**：
   - 无效请求拦截率达到99%+
   - 后端错误请求处理量减少80%+
   - 系统稳定性显著提升

### 技术栈

- **缓存**：localStorage、sessionStorage、Map
- **可视化**：ECharts
- **异步处理**：Promise、async/await、Web Worker
- **网络**：axios、fetch
- **工具库**：lodash（防抖节流）、protobufjs（可选）

### 实施步骤

1. 先实现请求层优化，包括按需请求和缓存机制
2. 然后实现可视化渲染优化，包括画布复用和Web Worker
3. 接着实现前后端协同异步解耦，包括异步任务处理和负载感知
4. 然后实现前端侧计算下沉，将轻量计算任务移至前端
5. 最后实现前端接口容错和资源保护，包括参数校验、指数退避和熔断机制

### 向后兼容

所有优化都保持向后兼容，不破坏现有功能，确保平滑过渡。