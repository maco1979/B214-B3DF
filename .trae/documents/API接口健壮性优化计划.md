# API接口健壮性优化计划

## 一、开发阶段优化

### 1. 统一配置管理
- **后端**：创建`src/core/settings.py`，使用`pydantic-settings`统一管理配置
- **前端**：完善`.env`配置，确保所有后端地址从环境变量读取
- **内容**：包含API地址、端口、超时设置、CORS配置等

### 2. 增强参数校验和错误处理
- **使用用户提供的代码片段**：`backend/src/core/response.py`，实现统一错误响应格式
- **标准化响应格式**：
  - 成功响应：`{"success": true, "code": 200, "data": {}, "message": "操作成功"}`
  - 失败响应：`{"success": false, "code": 400/401/403/500, "data": null, "message": "具体错误描述", "detail": {}}`

### 3. WebSocket通信健壮性优化
- **后端**：为摄像头WS接口添加「心跳检测」
- **前端**：使用用户提供的代码片段`frontend/src/utils/websocket.ts`，实现WS「断线自动重连 + 指数退避策略」
- **前后端**：统一WS通信格式，包括心跳包和错误信息

### 4. 完善日志记录
- **使用用户提供的代码片段**：`backend/src/core/logging_decorator.py`，实现通用日志装饰器

## 二、联调阶段优化

### 1. 接口文档自动化
- 确保所有API都有清晰的文档描述和示例

### 2. 跨域配置优化
- 优化CORS配置，支持环境区分

## 三、部署阶段优化

### 1. 容器化部署优化
- 完善Dockerfile，确保依赖版本固定
- 添加健康检查命令

### 2. 健康检查增强
- 添加更详细的健康检查，包括依赖服务状态

## 四、运行阶段优化

### 1. 监控系统集成
- 添加Prometheus监控指标

### 2. 容错和降级处理
- 为所有外部依赖添加「超时限制」
- 非核心接口添加「重试机制」

## 五、具体实现步骤

### 后端优化
1. 创建`src/core/settings.py`配置文件
2. 创建`src/core/response.py`，实现统一错误响应格式
3. 创建`src/core/logging_decorator.py`，实现日志装饰器
4. 修改`main.py`，使用配置文件中的端口而非硬编码
5. 修改WebSocket相关接口，添加心跳检测
6. 优化CORS配置，支持环境区分

### 前端优化
1. 创建`src/utils/websocket.ts`，实现WebSocket断线重连+心跳
2. 修改前端代码，使用新的WebSocket封装
3. 确保所有API请求使用环境变量中的后端地址

### 部署优化
1. 完善Dockerfile，添加健康检查
2. 添加docker-compose.yml，支持前后端统一部署

## 六、预期效果

彻底消除 API/WS 硬编码配置，所有地址 / 端口从环境变量读取，无端口不匹配导致的连接失败；
前后端统一错误响应格式，前端只需一套错误解析逻辑，错误提示精准、用户友好；
完善的日志和监控，接口报错后能快速定位问题根源，排查效率提升 10 倍；
WebSocket 实现断线自动重连 + 心跳机制，彻底解决「断开服务器」的核心问题；
增强的容错能力，单个接口报错不会导致整个服务崩溃，服务稳定性提升 100%；
标准化的部署流程，开发 / 测试 / 生产环境一致，无环境差异导致的接口失效；
自动生成的接口文档，前后端联调效率提升，无联调错误；
前端请求统一封装，超时、重试、错误捕获自动化，前端无冗余请求代码。