# 摄像头控制功能优化计划

## 现有实现分析

通过代码分析，发现报告中描述的大部分核心修复已经实现：

1. **✅ WebSocket 动态连接地址**：已在 `AIControl.tsx` 中实现，支持从环境变量动态获取地址，自动适配协议和端口
2. **✅ 详细错误信息**：已在 `camera_controller.py` 中实现，返回结构化错误数据，包含后端错误详情和解决方案建议
3. **✅ 前端错误提示**：已在 `AIControl.tsx` 中实现，WebSocket 错误会显示给用户
4. **✅ 完善的摄像头检测**：已在 `camera_controller.py` 中实现，测试多个后端，返回详细摄像头信息
5. **✅ CORS 配置**：已在后端 API 中实现，支持跨域请求

## 需要添加的优化

### 1. 前端摄像头选择下拉框
- **功能**：允许用户手动选择摄像头索引
- **实现位置**：`frontend/src/pages/AIControl.tsx`
- **技术细节**：
  - 添加摄像头列表状态和选择状态
  - 添加获取摄像头列表的 API 调用
  - 在 UI 中添加下拉选择框
  - 支持显示摄像头可用性和后端信息

### 2. 组件加载时自动获取摄像头列表
- **功能**：组件挂载时自动检测可用摄像头
- **实现位置**：`frontend/src/pages/AIControl.tsx`
- **技术细节**：
  - 在 `useEffect` 中调用 `/api/camera/list` 接口
  - 默认选择第一个可用摄像头

### 3. 摄像头超时释放机制
- **功能**：防止摄像头连接超时卡死
- **实现位置**：`backend/src/core/services/camera_controller.py`
- **技术细节**：
  - 在 `open_camera` 方法中添加超时配置
  - 设置 `CAP_PROP_OPEN_TIMEOUT_MSEC` 和 `CAP_PROP_READ_TIMEOUT_MSEC`

### 4. 前端防抖处理摄像头选择
- **功能**：避免频繁切换摄像头索引导致请求过多
- **实现位置**：`frontend/src/pages/AIControl.tsx`
- **技术细节**：
  - 使用 `lodash.debounce` 对摄像头选择事件进行防抖
  - 设置 300ms 延迟

## 实现步骤

1. **前端优化**：
   - 添加摄像头列表获取和状态管理
   - 实现摄像头选择下拉框
   - 添加组件加载时的自动摄像头检测
   - 实现防抖处理

2. **后端优化**：
   - 添加摄像头连接超时配置

3. **测试验证**：
   - 验证摄像头列表获取功能
   - 验证摄像头选择功能
   - 验证错误提示显示
   - 验证超时机制

## 预期效果

- 用户可直观选择可用摄像头
- 自动检测可用摄像头，减少手动配置
- 防止摄像头连接超时卡死
- 优化用户交互体验
- 提高系统稳定性

所有优化均为增量改进，不会破坏现有功能，可平滑集成到现有代码base中。