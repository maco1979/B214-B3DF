# PTZ云台摄像头控制系统使用指南

## 概述

本系统现已支持**真实的PTZ云台摄像头物理控制**，适用于农业监控、无人机控制、智能安防等实际应用场景。

## 核心特性

### 1. 物理云台控制
- ✅ 真实的硬件转动（非软件模拟）
- ✅ 支持水平旋转（Pan）：-180° 到 +180°
- ✅ 支持垂直旋转（Tilt）：-90° 到 +90°
- ✅ 支持变焦控制（Zoom）：1x 到 20x
- ✅ 支持对焦控制（Focus）
- ✅ 支持光圈控制（Iris）

### 2. 多种协议支持
- **Pelco-D**：最常用的工业标准协议
- **Pelco-P**：Pelco协议的另一个版本
- **VISCA**：Sony等厂商使用的协议
- **ONVIF**：标准网络摄像头协议
- **HTTP API**：支持HTTP接口的云台

### 3. 多种连接方式
- **串口连接**：通过RS-485/RS-232连接
  - Windows: `COM3`, `COM4` 等
  - Linux/Mac: `/dev/ttyUSB0`, `/dev/ttyUSB1` 等
  - 波特率: 2400, 4800, 9600, 19200, 38400
  
- **网络连接**：通过TCP/IP连接
  - 支持IP地址和端口配置
  - 适用于网络云台摄像头
  
- **HTTP连接**：通过HTTP API连接
  - 支持用户名密码认证
  - 适用于支持Web API的云台

## 应用场景

### 1. 农业监控
```
场景：智能大棚监控
功能：
- 自动巡航检查作物生长状况
- 预置位监控不同区域
- 根据AI识别结果自动转动
- 检测植物病虫害
- 监控植物生长情况
```

### 2. 无人机控制
```
场景：无人机地面站
功能：
- 地面PTZ云台跟踪无人机
- 自动对焦保持画面清晰
- 记录预置位快速切换视角
- 支持远程控制
```

### 3. 智能安防
```
场景：周界安防监控
功能：
- 自动巡航预设路线
- 入侵检测自动转向
- 预置位快速响应
- 变焦拉近查看细节
```

### 4. 智能养殖
```
场景：养殖场监控
功能：
- 监控动物活动状态
- 自动跟踪目标动物
- 检测异常行为
- 多区域巡航监控
```

## 使用方法

### 1. 连接云台摄像头

#### 方式A：串口连接（最常用）
```
1. 找到云台的RS-485接口
2. 使用USB转RS-485转换器连接到电脑
3. 在设备管理器中查看COM口号（Windows）或 /dev/ttyUSB0（Linux）
4. 在前端界面选择：
   - 协议：Pelco-D（默认）
   - 连接类型：串口
   - 串口：COM3（Windows）或 /dev/ttyUSB0（Linux）
   - 波特率：9600（默认）
5. 点击"连接PTZ云台"
```

#### 方式B：网络连接
```
1. 确保云台摄像头已连接到局域网
2. 查看云台的IP地址（通常在设备标签上）
3. 在前端界面选择：
   - 协议：ONVIF 或 Pelco-D
   - 连接类型：网络
   - IP地址：192.168.1.100（示例）
   - 端口：5000（示例）
4. 点击"连接PTZ云台"
```

#### 方式C：HTTP连接
```
1. 查看云台的Web管理地址
2. 在前端界面选择：
   - 协议：HTTP API
   - 连接类型：HTTP
   - URL地址：http://192.168.1.100
   - 用户名：admin（默认）
   - 密码：admin（默认）
3. 点击"连接PTZ云台"
```

### 2. 控制云台

#### 基本方向控制
```
- ▲：向上转动
- ▼：向下转动
- ◄：向左转动
- ►：向右转动
- 停止：立即停止所有动作
```

#### 变焦控制
```
- 拉近(+)：放大画面
- 拉远(-)：缩小画面
```

#### 速度调整
```
- 使用滑块调整0-100的转动速度
- 速度越高转动越快
```

### 3. 预置位功能

#### 设置预置位
```
1. 手动控制云台转到目标位置
2. 输入预置位编号（1-256）
3. 输入预置位名称（如"大门"、"后院"）
4. 点击"设置预置位"
```

#### 使用预置位
```
1. 输入预置位编号
2. 点击"转到预置位"
3. 云台会自动转到保存的位置
```

### 4. 高级功能

#### 自动巡航
```python
# 后端API示例
POST /api/camera/ptz/patrol
{
  "presets": [1, 2, 3, 4],  # 预置位列表
  "dwell_time": 5           # 每个位置停留5秒
}
```

#### AI自动跟踪
```
当视觉识别检测到目标时，云台会自动调整方向保持目标在画面中心。
```

## API接口

### 1. 连接云台
```
POST /api/camera/ptz/connect
Body:
{
  "protocol": "pelco_d",
  "connection_type": "serial",
  "port": "/dev/ttyUSB0",
  "baudrate": 9600,
  "address": 1
}
```

### 2. 执行动作
```
POST /api/camera/ptz/action
Body:
{
  "action": "pan_right",  // pan_left, tilt_up, tilt_down, zoom_in, zoom_out, stop
  "speed": 50            // 0-100
}
```

### 3. 移动到位置
```
POST /api/camera/ptz/move
Body:
{
  "pan": 45.0,    // 水平角度
  "tilt": 30.0,   // 垂直角度
  "zoom": 5.0,    // 变焦倍数
  "speed": 50
}
```

### 4. 设置预置位
```
POST /api/camera/ptz/preset/set
Body:
{
  "preset_id": 1,
  "name": "大门"
}
```

### 5. 转到预置位
```
POST /api/camera/ptz/preset/goto
Body:
{
  "preset_id": 1
}
```

### 6. 自动巡航
```
POST /api/camera/ptz/patrol
Body:
{
  "presets": [1, 2, 3],
  "dwell_time": 5
}
```

### 7. 获取状态
```
GET /api/camera/ptz/status
Response:
{
  "success": true,
  "data": {
    "connected": true,
    "protocol": "pelco_d",
    "connection_type": "serial",
    "position": {
      "pan": 45.0,
      "tilt": 30.0,
      "zoom": 5.0
    },
    "presets": {
      "1": {"pan": 0, "tilt": 0, "zoom": 1, "name": "默认位置"}
    }
  }
}
```

## 前端集成

### 在AI控制页面使用
```
1. 打开 http://localhost:3003/ai-control
2. 在右侧"视觉智能"卡片中点击"🎯 PTZ云台"标签页
3. 配置连接参数
4. 连接并控制云台
```

### 组件引用
```tsx
import { PTZControl } from '@/components/PTZControl';

<PTZControl apiClient={apiClient} />
```

## 硬件要求

### 1. 云台摄像头
- 支持Pelco-D/P、VISCA、ONVIF协议之一
- 带RS-485/RS-232接口或网络接口
- 供电：12V DC 或 24V AC（视型号而定）

### 2. 连接设备
- **串口连接**：USB转RS-485/RS-232转换器
- **网络连接**：网络交换机、路由器
- **电脑要求**：支持串口或网络连接

### 3. 推荐设备型号（示例）
- 海康威视DS-2DC系列
- 大华DH-SD系列
- 宇视IPC-PT系列
- 任何支持标准协议的云台摄像头

## 常见问题

### Q1: 连接失败怎么办？
```
A: 检查以下项目：
1. 确认串口号正确（Windows设备管理器中查看）
2. 确认波特率与云台设置一致（默认9600）
3. 检查RS-485接线是否正确（A+, B-）
4. 确认云台地址码设置正确（默认1）
5. 检查云台供电是否正常
```

### Q2: 云台不转动？
```
A: 可能原因：
1. 协议选择错误（尝试Pelco-D）
2. 地址码不匹配（检查云台DIP开关）
3. 波特率不正确
4. RS-485接线反了（尝试对调A+, B-）
```

### Q3: 转动方向相反？
```
A: 这是正常的，不同云台可能方向定义不同
可以在前端界面手动调整使用方式
```

### Q4: Windows下找不到串口？
```
A: 
1. 安装USB转RS-485驱动程序
2. 在设备管理器中查看"端口(COM和LPT)"
3. 如果没有显示，检查USB连接或驱动安装
```

### Q5: Linux下权限不足？
```
A:
sudo chmod 666 /dev/ttyUSB0
或
sudo usermod -a -G dialout $USER
然后重新登录
```

## 技术架构

### 后端
- 文件：`backend/src/core/services/ptz_camera_controller.py`
- API：`backend/src/api/routes/camera.py` 的 `/ptz/*` 端点
- 支持异步操作
- 线程安全设计

### 前端
- 组件：`frontend/src/components/PTZControl.tsx`
- 集成：`frontend/src/pages/AIControl.tsx`
- 实时状态更新
- 友好的用户界面

## 未来扩展

### 1. AI联动
- 自动目标跟踪
- 行为识别自动转向
- 异常检测告警

### 2. 多云台协同
- 多个云台联动控制
- 全景拼接
- 智能切换

### 3. 录像回放
- 云台位置记录
- 轨迹回放
- 定时巡航

## 技术支持

如需帮助，请参考：
1. 云台摄像头产品手册
2. Pelco协议文档
3. 系统日志：`backend/logs/`
4. 浏览器控制台（F12）

## 总结

现在系统已经支持**真实的PTZ云台摄像头控制**，可以满足：
- ✅ 农业监控自动巡检
- ✅ 植物病虫害检测
- ✅ 无人机地面站控制
- ✅ 智能安防系统
- ✅ 养殖场监控管理

这是一个完整的工业级云台控制解决方案！
