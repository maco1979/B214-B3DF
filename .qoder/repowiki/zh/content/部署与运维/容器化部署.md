# 容器化部署

<cite>
**本文档引用的文件**  
- [docker-compose.yml](file://docker-compose.yml)
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml)
- [decision-service/docker-compose.yml](file://decision-service/docker-compose.yml)
- [frontend/Dockerfile](file://frontend/Dockerfile)
- [backend/Dockerfile](file://backend/Dockerfile)
- [decision-service/Dockerfile](file://decision-service/Dockerfile)
- [.env](file://.env)
- [backend/.env](file://backend/.env)
- [decision-service/.env](file://decision-service/.env)
- [api-gateway/.env](file://api-gateway/.env)
</cite>

## 目录

1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介

本文档提供了一个全面的容器化部署指南，重点分析了AI决策系统的Docker和docker-compose配置。文档详细解析了前端、后端、数据库、Redis等服务的Docker镜像构建过程，包括上下文路径、端口映射和卷挂载策略。同时，文档还涵盖了多环境配置管理、容器间通信、健康检查设置和资源限制优化等关键主题。

## 项目结构

本项目采用微服务架构，包含多个独立的服务组件，每个组件都有自己的Dockerfile和配置文件。主要组件包括前端、后端API、决策服务、数据库、Redis缓存以及监控系统（Prometheus和Grafana）。项目根目录下的docker-compose.yml文件定义了生产环境的完整服务拓扑，而infrastructure目录下提供了开发和测试环境的独立配置。

```mermaid
graph TD
A[根目录] --> B[docker-compose.yml]
A --> C[infrastructure]
A --> D[backend]
A --> E[frontend]
A --> F[decision-service]
C --> G[docker-compose.yml]
D --> H[Dockerfile]
E --> I[Dockerfile]
F --> J[Dockerfile]
```

**Diagram sources**  
- [docker-compose.yml](file://docker-compose.yml#L1-L113)
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml#L1-L123)

**Section sources**  
- [docker-compose.yml](file://docker-compose.yml#L1-L113)
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml#L1-L123)

## 核心组件

本系统的核心组件包括后端API服务、前端Web界面、决策引擎、数据库和缓存系统。后端服务基于Python和FastAPI构建，负责处理业务逻辑和数据管理。前端采用现代Web技术栈，提供用户友好的交互界面。决策服务作为独立的微服务，专注于复杂的AI决策逻辑。PostgreSQL作为主数据库存储结构化数据，Redis则用于高速缓存和会话管理。

**Section sources**  
- [backend/Dockerfile](file://backend/Dockerfile#L1-L34)
- [frontend/Dockerfile](file://frontend/Dockerfile#L1-L32)
- [decision-service/Dockerfile](file://decision-service/Dockerfile#L1-L29)

## 架构概览

系统采用分层的微服务架构，所有服务通过自定义的Docker网络进行通信。前端服务通过Nginx提供静态文件服务，后端API服务暴露REST接口，决策服务处理复杂的AI决策逻辑，所有服务共享数据库和缓存基础设施。监控系统（Prometheus和Grafana）提供全面的性能指标收集和可视化。

```mermaid
graph TB
subgraph "前端层"
Frontend[前端服务]
end
subgraph "API层"
Backend[后端API服务]
Gateway[API网关]
end
subgraph "业务逻辑层"
Decision[决策服务]
end
subgraph "数据层"
DB[(PostgreSQL)]
Redis[(Redis)]
end
subgraph "监控层"
Prometheus[Prometheus]
Grafana[Grafana]
end
Frontend --> Backend
Backend --> Decision
Backend --> DB
Backend --> Redis
Decision --> DB
Decision --> Redis
Backend --> Prometheus
Decision --> Prometheus
Prometheus --> Grafana
```

**Diagram sources**  
- [docker-compose.yml](file://docker-compose.yml#L3-L113)
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml#L3-L123)

## 详细组件分析

### 后端服务分析

后端服务是系统的核心业务逻辑处理单元，负责管理AI决策流程、用户认证、数据持久化等关键功能。服务通过Docker容器化部署，采用Python 3.9-slim作为基础镜像，确保了较小的镜像体积和较高的安全性。

#### 构建配置
```mermaid
graph TD
A[开始构建] --> B[使用python:3.9-slim基础镜像]
B --> C[设置工作目录/app]
C --> D[安装系统依赖gcc,g++]
D --> E[复制requirements.txt]
E --> F[安装Python依赖]
F --> G[复制应用代码]
G --> H[创建非root用户appuser]
H --> I[切换到appuser用户]
I --> J[暴露端口8000]
J --> K[设置健康检查]
K --> L[启动uvicorn服务器]
```

**Diagram sources**  
- [backend/Dockerfile](file://backend/Dockerfile#L1-L34)

#### 环境变量与依赖关系
后端服务依赖于数据库和Redis服务，通过环境变量进行配置。服务启动时会等待依赖服务就绪，并通过健康检查确保服务可用性。

| 环境变量 | 描述 | 默认值 |
|---------|------|-------|
| ENVIRONMENT | 运行环境 | production |
| LOG_LEVEL | 日志级别 | INFO |
| DATABASE_URL | 数据库连接字符串 | postgresql://ai_user:ai_password@postgres:5432/ai_platform |
| REDIS_URL | Redis连接字符串 | redis://redis:6379/0 |

**Section sources**  
- [backend/Dockerfile](file://backend/Dockerfile#L1-L34)
- [docker-compose.yml](file://docker-compose.yml#L5-L25)

### 前端服务分析

前端服务采用多阶段Docker构建策略，第一阶段使用Node.js镜像进行应用构建，第二阶段使用轻量级Nginx镜像提供生产环境的静态文件服务。

#### 构建流程
```mermaid
sequenceDiagram
participant Builder as 构建阶段
participant Runtime as 运行阶段
participant Nginx as Nginx服务器
Builder->>Builder : 使用node : 18-alpine镜像
Builder->>Builder : 设置工作目录/app
Builder->>Builder : 复制package*.json
Builder->>Builder : 安装生产依赖
Builder->>Builder : 复制源代码
Builder->>Builder : 执行npm run build
Builder->>Runtime : 复制构建产物到/nginx/html
Runtime->>Runtime : 复制nginx.conf配置
Runtime->>Nginx : 启动Nginx服务
```

**Diagram sources**  
- [frontend/Dockerfile](file://frontend/Dockerfile#L1-L32)

#### 配置策略
前端服务通过环境变量VITE_API_BASE_URL配置API后端地址，支持开发和生产环境的不同配置。服务使用卷挂载实现开发环境的热重载，提高开发效率。

**Section sources**  
- [frontend/Dockerfile](file://frontend/Dockerfile#L1-L32)
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml#L5-L21)

### 数据库与缓存服务

系统使用PostgreSQL作为主数据库，Redis作为缓存和会话存储。两个服务都配置了数据卷以确保数据持久化，防止容器重启导致数据丢失。

#### 数据持久化策略
```mermaid
flowchart TD
A[服务启动] --> B{数据卷存在?}
B --> |是| C[挂载现有数据]
B --> |否| D[创建新数据卷]
C --> E[启动数据库服务]
D --> E
E --> F[执行初始化脚本]
F --> G[服务就绪]
```

**Diagram sources**  
- [docker-compose.yml](file://docker-compose.yml#L55-L70)
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml#L43-L57)

#### 网络拓扑
所有服务通过名为ai-network的自定义Docker网络进行通信，确保服务间的安全隔离和高效通信。

**Section sources**  
- [docker-compose.yml](file://docker-compose.yml#L55-L70)
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml#L43-L57)

## 依赖分析

系统各组件之间存在明确的依赖关系，通过docker-compose的depends_on指令进行声明。前端服务依赖后端API服务，后端服务依赖数据库和Redis服务，监控系统依赖Prometheus数据源。

```mermaid
graph TD
Grafana --> Prometheus
Prometheus --> Backend
Prometheus --> Decision
Backend --> DB
Backend --> Redis
Decision --> DB
Decision --> Redis
Frontend --> Backend
Backend --> Decision
```

**Diagram sources**  
- [docker-compose.yml](file://docker-compose.yml#L36-L38)
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml#L18-L19)

**Section sources**  
- [docker-compose.yml](file://docker-compose.yml#L36-L38)
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml#L18-L19)

## 性能考虑

### 资源限制优化
生产环境的docker-compose配置中，所有关键服务都设置了restart: unless-stopped策略，确保服务在异常退出后能够自动重启。同时，通过健康检查机制监控服务状态，确保只有健康的实例才接收流量。

### 健康检查配置
各服务都配置了合理的健康检查策略，包括适当的间隔时间、超时时间和重试次数，避免因短暂的网络波动导致服务被错误地标记为不健康。

| 服务 | 检查间隔 | 超时时间 | 重试次数 | 启动等待期 |
|------|----------|----------|----------|------------|
| 后端 | 30秒 | 10秒 | 3次 | 40秒 |
| 决策服务 | 30秒 | 10秒 | 3次 | 无 |
| 前端 | 无 | 无 | 无 | 无 |

**Section sources**  
- [docker-compose.yml](file://docker-compose.yml#L17-L22)
- [decision-service/docker-compose.yml](file://decision-service/docker-compose.yml#L16-L21)

## 故障排除指南

### 常见构建失败排查
1. **依赖安装失败**：检查网络连接，确保能够访问Python包索引
2. **端口冲突**：确认主机端口未被其他进程占用
3. **权限问题**：确保Docker有权限访问项目文件和目录
4. **环境变量缺失**：检查.env文件是否存在且配置正确

### 多环境配置管理
系统通过不同层级的.env文件实现多环境配置管理：
- 根目录.env：全局默认配置
- 服务目录.env：服务特定配置
- 环境特定配置：通过docker-compose覆盖文件实现

环境变量注入遵循优先级顺序：命令行 > docker-compose文件 > .env文件 > 默认值。

**Section sources**  
- [.env](file://.env#L1-L27)
- [backend/.env](file://backend/.env#L1-L5)
- [decision-service/.env](file://decision-service/.env#L1-L25)
- [api-gateway/.env](file://api-gateway/.env#L1-L43)

## 结论

本容器化部署方案为AI决策系统提供了稳定、可扩展的运行环境。通过合理的Docker配置和docker-compose编排，实现了服务的解耦、数据的持久化和系统的高可用性。多环境配置管理和完善的监控体系为系统的持续集成和部署提供了坚实基础。