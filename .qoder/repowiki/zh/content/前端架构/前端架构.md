# 前端架构

<cite>
**本文档中引用的文件**   
- [package.json](file://frontend/package.json)
- [vite.config.ts](file://frontend/vite.config.ts)
- [main.tsx](file://frontend/src/main.tsx)
- [App.tsx](file://frontend/src/App.tsx)
- [tailwind.config.js](file://frontend/tailwind.config.js)
- [BentoCard.tsx](file://frontend/src/components/ui/BentoCard.tsx)
- [GalaxyUI.tsx](file://frontend/src/components/GalaxyUI.tsx)
- [MainLayout.tsx](file://frontend/src/components/layout/MainLayout.tsx)
- [useAuth.tsx](file://frontend/src/hooks/useAuth.tsx)
- [useEventSource.ts](file://frontend/src/hooks/useEventSource.ts)
- [api-client.ts](file://frontend/src/lib/api-client.ts)
- [api.ts](file://frontend/src/services/api.ts)
- [query-client.ts](file://frontend/src/lib/query-client.ts)
- [Dashboard.tsx](file://frontend/src/pages/Dashboard.tsx)
- [AIControl.tsx](file://frontend/src/pages/AIControl.tsx)
- [Agriculture.tsx](file://frontend/src/pages/Agriculture.tsx)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心架构](#核心架构)
3. [组件体系](#组件体系)
4. [状态管理](#状态管理)
5. [路由机制](#路由机制)
6. [API集成](#api集成)
7. [页面结构](#页面结构)
8. [开发工作流](#开发工作流)

## 项目结构

前端项目采用基于React 18与TypeScript的现代前端架构，使用Vite作为构建工具，结合Tailwind CSS进行样式化。项目结构清晰，按功能模块组织，主要包含组件、页面、服务、钩子和工具库等目录。

```mermaid
graph TD
A[前端项目] --> B[src]
B --> C[components]
B --> D[pages]
B --> E[services]
B --> F[lib]
B --> G[hooks]
B --> H[config]
C --> I[ui]
C --> J[layout]
C --> K[自定义组件]
D --> L[Dashboard]
D --> M[AIControl]
D --> N[Agriculture]
E --> O[api.ts]
F --> P[api-client.ts]
F --> Q[query-client.ts]
G --> R[useAuth.tsx]
G --> S[useEventSource.ts]
```

**图源**
- [package.json](file://frontend/package.json)
- [vite.config.ts](file://frontend/vite.config.ts)
- [tailwind.config.js](file://frontend/tailwind.config.js)

## 核心架构

前端应用采用现代化的React架构，基于React 18的并发特性，结合TypeScript提供类型安全。使用Vite作为构建工具，提供快速的开发服务器启动和热模块替换。应用整体架构分为UI层、状态管理层、服务层和数据获取层。

```mermaid
graph TB
A[用户界面] --> B[React组件]
B --> C[UI组件]
B --> D[页面组件]
C --> E[Tailwind CSS]
D --> F[路由]
G[状态管理] --> H[React Query]
H --> I[缓存]
H --> J[同步]
K[服务层] --> L[API客户端]
L --> M[认证]
L --> N[错误处理]
O[数据获取] --> P[EventSource]
P --> Q[实时更新]
R[构建] --> S[Vite]
S --> T[开发服务器]
S --> U[生产构建]
```

**图源**
- [main.tsx](file://frontend/src/main.tsx)
- [App.tsx](file://frontend/src/App.tsx)
- [lib/query-client.ts](file://frontend/src/lib/query-client.ts)

## 组件体系

前端应用构建了一套完整的UI组件体系，基于React 18与TypeScript，采用原子设计原则。组件体系包括基础UI组件、布局组件和高级自定义组件。

### BentoCard组件

BentoCard是一个高级UI组件，用于创建具有悬停效果和装饰性背景的卡片。它使用framer-motion实现动画效果，支持标题、图标、描述和自定义内容。

```mermaid
classDiagram
class BentoCard {
+children : ReactNode
+className? : string
+title? : string
+icon? : ComponentType
+description? : string
+render() : JSX.Element
}
```

**图源**
- [BentoCard.tsx](file://frontend/src/components/ui/BentoCard.tsx)

### GalaxyUI组件库

GalaxyUI是一套自定义UI组件库，提供了一系列具有统一视觉风格的组件，包括卡片、按钮、输入框、徽章、进度条、模态框、统计卡片、开关、头像、标签、时间线、加载器和通知等。

```mermaid
classDiagram
class GalaxyCard {
+children : ReactNode
+className? : string
+onClick? : () => void
}
class GalaxyButton {
+children : ReactNode
+variant? : 'primary' | 'secondary'
+onClick? : () => void
+disabled? : boolean
+className? : string
}
class GalaxyInput {
+label? : string
+其他HTML输入属性
}
class GalaxyBadge {
+children : ReactNode
+variant? : 'default' | 'success' | 'warning'
}
GalaxyCard --> GalaxyButton
GalaxyCard --> GalaxyInput
GalaxyCard --> GalaxyBadge
```

**图源**
- [GalaxyUI.tsx](file://frontend/src/components/GalaxyUI.tsx)

## 状态管理

前端应用采用多层状态管理策略，结合React Context和React Query，实现全局状态和数据状态的有效管理。

### 认证状态管理

使用React Context实现认证状态管理，通过AuthProvider提供认证上下文，包含用户信息、登录、登出和认证状态等。

```mermaid
sequenceDiagram
participant UI as "用户界面"
participant Auth as "AuthProvider"
participant API as "API客户端"
UI->>Auth : 调用login(email, password)
Auth->>API : 调用apiClient.login()
API-->>Auth : 返回登录响应
Auth->>Auth : 更新用户状态
Auth->>Auth : 存储用户信息到localStorage
Auth-->>UI : 认证完成
```

**图源**
- [useAuth.tsx](file://frontend/src/hooks/useAuth.tsx)

### 数据状态管理

使用React Query进行数据获取和状态管理，提供数据缓存、自动刷新、错误处理和持久化等功能。通过自定义hooks封装数据查询逻辑。

```mermaid
classDiagram
class QueryClient {
+defaultOptions
+cache
+persister
}
class useModelsQuery {
+queryKey : ['models']
+queryFn : fetchModels
+staleTime : 5分钟
+select : 处理空数据
}
class useSystemQueries {
+useSystemMetricsQuery
+useBlockchainStatusQuery
+useEdgeDevicesQuery
}
QueryClient --> useModelsQuery
QueryClient --> useSystemQueries
```

**图源**
- [query-client.ts](file://frontend/src/lib/query-client.ts)
- [useModelsQuery.ts](file://frontend/src/hooks/useModelsQuery.ts)

## 路由机制

前端应用使用React Router DOM实现路由管理，采用懒加载策略优化性能。路由配置包含登录页面和受保护的业务路由，通过MainLayout包装业务页面。

```mermaid
graph TD
A[Router] --> B[AuthProvider]
B --> C[QueryClientProvider]
C --> D[ErrorBoundary]
D --> E[Suspense]
E --> F[Routes]
F --> G[/login]
F --> H[/]
F --> I[/agriculture]
F --> J[/models]
F --> K[/models/:id]
F --> L[/inference]
F --> M[/blockchain]
F --> N[/federated]
F --> O[/monitoring]
F --> P[/performance]
F --> Q[/settings]
F --> R[/community]
F --> S[/ai-control]
H --> T[MainLayout]
I --> T
J --> T
K --> T
L --> T
M --> T
N --> T
O --> T
P --> T
Q --> T
R --> T
S --> T
```

**图源**
- [App.tsx](file://frontend/src/App.tsx)

## API集成

前端应用通过API客户端与后端API网关通信，实现认证处理、错误拦截和实时数据更新等功能。

### API客户端实现

API客户端基于Axios构建，包含请求拦截器和响应拦截器，自动注入API Key和Bearer Token，统一处理401/403错误并重定向到登录页面。

```mermaid
sequenceDiagram
participant Component as "组件"
participant API as "apiClient"
participant Axios as "Axios实例"
participant Request as "请求拦截器"
participant Response as "响应拦截器"
Component->>API : 调用getModels()
API->>Axios : 发送请求
Axios->>Request : 触发请求拦截器
Request->>Request : 注入API Key
Request->>Request : 注入Bearer Token
Request-->>Axios : 继续请求
Axios->>Backend : 发送到后端
Backend-->>Axios : 返回响应
Axios->>Response : 触发响应拦截器
Response->>Response : 检查401/403状态
alt 状态为401或403
Response->>Auth : 调用clearAuthAndRedirect()
Auth->>Window : 重定向到登录页
else 其他状态
Response->>Response : 显示错误通知
Response-->>API : 返回处理后的响应
end
API-->>Component : 返回数据
```

**图源**
- [api-client.ts](file://frontend/src/lib/api-client.ts)
- [api.ts](file://frontend/src/services/api.ts)

### 实时数据更新

使用EventSource实现服务器发送事件(SSE)的实时数据更新，通过useEventSource自定义Hook封装SSE逻辑，支持自动重连、数据更新策略和与React Query集成。

```mermaid
sequenceDiagram
participant Component as "组件"
participant Hook as "useEventSource"
participant EventSource as "EventSource"
participant QueryClient as "QueryClient"
Component->>Hook : 调用useEventSource()
Hook->>Hook : 构建SSE URL
Hook->>EventSource : 创建EventSource实例
EventSource-->>Hook : 接收消息事件
Hook->>Hook : 解析消息数据
alt 配置了queryKey
Hook->>QueryClient : 调用setQueryData()
QueryClient->>QueryClient : 应用更新策略
end
alt 配置了onEvent回调
Hook->>Component : 调用onEvent回调
end
EventSource->>Hook : 发生错误
Hook->>Hook : 关闭当前连接
Hook->>Hook : 设置重连定时器
Hook->>EventSource : 重新连接
```

**图源**
- [useEventSource.ts](file://frontend/src/hooks/useEventSource.ts)

## 页面结构

前端应用包含多个功能页面，每个页面都有特定的用户交互流程和数据展示需求。

### Dashboard页面

Dashboard页面是系统概览页面，展示关键指标、AI代理、遥测数据和系统日志。使用BentoCard组件构建网格布局，通过多个数据查询获取系统状态。

```mermaid
flowchart TD
A[Dashboard页面] --> B[状态初始化]
B --> C[获取模型数据]
C --> D[获取系统指标]
D --> E[获取区块链状态]
E --> F[获取边缘设备]
F --> G[渲染统计卡片]
G --> H[渲染AI代理]
H --> I[渲染遥测图表]
I --> J[渲染系统日志]
J --> K[用户交互]
K --> L[刷新数据]
L --> D
K --> M[切换AI核心]
M --> N[调用API]
N --> O[更新状态]
O --> G
```

**图源**
- [Dashboard.tsx](file://frontend/src/pages/Dashboard.tsx)

### AIControl页面

AIControl页面是AI控制中心，提供设备编排、模式预设、视觉智能和JEPA预测等功能。支持语音控制和摄像头集成。

```mermaid
flowchart TD
A[AIControl页面] --> B[状态初始化]
B --> C[获取设备列表]
C --> D[获取JEPA状态]
D --> E[检查主控状态]
E --> F[渲染预设模式]
F --> G[渲染设备矩阵]
G --> H[渲染视觉馈送]
H --> I[渲染JEPA控制]
I --> J[用户交互]
J --> K[切换语音控制]
K --> L[启动语音识别]
L --> M[监听语音命令]
M --> N[执行相应操作]
J --> O[切换主控]
O --> P[调用API]
P --> Q[更新状态]
J --> R[切换JEPA]
R --> S[调用API]
S --> T[更新状态]
J --> U[切换摄像头]
U --> V[调用API]
V --> W[启动帧循环]
W --> X[获取摄像头帧]
X --> H
```

**图源**
- [AIControl.tsx](file://frontend/src/pages/AIControl.tsx)

### Agriculture页面

Agriculture页面是农业智能页面，提供作物选择、环境设置、光配方生成、生长预测和种植计划等功能。

```mermaid
flowchart TD
A[Agriculture页面] --> B[加载作物配置]
B --> C[获取API数据]
C --> D{成功?}
D --> |是| E[设置作物配置]
D --> |否| F[使用默认配置]
F --> G[显示错误信息]
E --> H[渲染作物选择]
H --> I[渲染环境设置]
I --> J[渲染光配方系统]
J --> K[渲染生长预测]
K --> L[渲染种植计划]
L --> M[用户交互]
M --> N[生成光配方]
N --> O[调用API]
O --> P[设置光配方]
P --> J
M --> Q[预测生长]
Q --> R[调用API]
R --> S[设置生长预测]
S --> K
M --> T[创建种植计划]
T --> U[调用API]
U --> V[设置种植计划]
V --> L
M --> W[贡献数据]
W --> X[调用API]
X --> Y[显示积分]
```

**图源**
- [Agriculture.tsx](file://frontend/src/pages/Agriculture.tsx)

## 开发工作流

前端应用提供完整的开发、测试与构建工作流，基于现代前端工具链。

### 开发环境

使用Vite提供快速的开发服务器，支持热模块替换和代理配置。开发服务器监听3000端口，代理API请求到后端服务。

```mermaid
flowchart LR
A[开发服务器] --> B[Vite]
B --> C[端口3000]
C --> D[代理配置]
D --> E[/api -> http://localhost:8002]
B --> F[TypeScript支持]
B --> G[React插件]
B --> H[别名@ -> src]
B --> I[测试配置]
```

**图源**
- [vite.config.ts](file://frontend/vite.config.ts)

### 构建配置

使用Vite进行生产构建，输出到dist目录，生成源映射文件。构建过程包括TypeScript类型检查和代码打包。

```mermaid
flowchart LR
A[构建脚本] --> B[npm run build]
B --> C[tsc && vite build]
C --> D[TypeScript编译]
D --> E[Vite构建]
E --> F[输出到dist目录]
F --> G[生成源映射]
G --> H[优化代码]
H --> I[生成静态资源]
```

**图源**
- [package.json](file://frontend/package.json)
- [vite.config.ts](file://frontend/vite.config.ts)

### 测试配置

使用Vitest进行单元测试和UI测试，配置JSDOM环境和测试工具库。支持测试覆盖率和UI测试界面。

```mermaid
flowchart LR
A[测试脚本] --> B[npm run test]
B --> C[Vitest]
C --> D[JSDOM环境]
D --> E[测试文件]
E --> F[@testing-library]
F --> G[用户事件]
G --> H[断言]
A --> I[npm run test:ui]
I --> J[Vitest UI]
J --> K[浏览器界面]
```

**图源**
- [package.json](file://frontend/package.json)
- [vite.config.ts](file://frontend/vite.config.ts)